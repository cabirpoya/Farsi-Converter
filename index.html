<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>استخراجگر فارسی - OCR مخصوص متون فارسی</title>
    <!-- Required OCR and PDF libraries -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.0.379/pdf.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Naskh+Arabic:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Noto Naskh Arabic', serif;
            background-color: #f8fafc;
        }
        .rtl-text {
            direction: rtl;
            text-align: right;
        }
        .dropzone {
            border: 2px dashed #3b82f6;
            transition: all 0.3s;
        }
        .dropzone:hover {
            background-color: #eff6ff;
        }
        .farsi-shadow {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .feature-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .nav-link::after {
            content: '';
            display: block;
            width: 0;
            height: 2px;
            background: #3b82f6;
            transition: width 0.3s;
        }
        .nav-link:hover::after {
            width: 100%;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- ... your page content ... -->
    <!-- (Paste your full HTML content here, as you already have) -->
    <!-- For brevity, not repeating the entire content, but keep all your sections as before -->

    <!-- Place this just before the closing </body> tag: -->
    <script>
    // --- Helper Functions ---
    function postProcessFarsi(text) {
        return text
            .replace(/ي/g, 'ی')
            .replace(/ك/g, 'ک')
            .replace(/[\u200c]/g, '')
            .replace(/ +/g, ' ')
            .replace(/([.،!؟])([^\s])/g, '$1 $2');
    }
    function preprocessImage(file, callback) {
        const img = new Image();
        img.onload = function() {
            const canvas = document.createElement('canvas');
            canvas.width = img.width; canvas.height = img.height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0);
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            for (let i = 0; i < imageData.data.length; i += 4) {
                const avg = (imageData.data[i] + imageData.data[i+1] + imageData.data[i+2]) / 3;
                imageData.data[i] = imageData.data[i+1] = imageData.data[i+2] = avg;
            }
            ctx.putImageData(imageData, 0, 0);
            callback(canvas.toDataURL());
        };
        img.src = URL.createObjectURL(file);
    }
    function copyToClipboard(text) {
        navigator.clipboard.writeText(text);
    }
    function downloadText(text, filename) {
        const blob = new Blob([text], {type: "text/plain"});
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = filename || "extracted.txt";
        link.click();
    }
    function resetDropzone() {
        location.reload();
    }

    // --- Main Logic ---
    document.addEventListener('DOMContentLoaded', function() {
        // Find or create required elements
        let dropzone = document.querySelector('.dropzone');
        if (!dropzone) return;
        let resultContainer = document.createElement('div');
        resultContainer.id = "result-container";
        resultContainer.className = "bg-white rounded-lg p-4 shadow-md mb-8";
        dropzone.parentNode.insertBefore(resultContainer, dropzone.nextSibling);

        let progressContainer = document.createElement('div');
        progressContainer.id = "progress-container";
        progressContainer.className = "hidden mb-4";
        progressContainer.innerHTML = `
            <div class="flex justify-between mb-1">
                <span class="text-sm font-medium text-blue-700">در حال پردازش...</span>
                <span id="progress-percent" class="text-sm font-medium text-blue-700">0%</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2.5">
                <div id="progress-bar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
            </div>
        `;
        dropzone.parentNode.insertBefore(progressContainer, dropzone.nextSibling);

        // File input
        const fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.accept = 'image/*,.pdf';
        fileInput.multiple = true;
        fileInput.style.display = 'none';
        document.body.appendChild(fileInput);

        // Dropzone click/select
        dropzone.addEventListener('click', (e) => {
            if (!e.target.classList.contains('bg-blue-50')) fileInput.click();
        });
        let selectBtn = dropzone.querySelector('button');
        if (selectBtn) selectBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            fileInput.click();
        });

        // Drag and drop
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropzone.addEventListener(eventName, preventDefaults, false);
        });
        function preventDefaults(e) { e.preventDefault(); e.stopPropagation(); }
        ['dragenter', 'dragover'].forEach(eventName => {
            dropzone.addEventListener(eventName, () => dropzone.classList.add('bg-blue-100', 'border-blue-400'), false);
        });
        ['dragleave', 'drop'].forEach(eventName => {
            dropzone.addEventListener(eventName, () => dropzone.classList.remove('bg-blue-100', 'border-blue-400'), false);
        });
        dropzone.addEventListener('drop', function(e) {
            fileInput.files = e.dataTransfer.files;
            const event = new Event('change');
            fileInput.dispatchEvent(event);
        });

        // File processing
        fileInput.addEventListener('change', async (e) => {
            const files = Array.from(e.target.files);
            if (!files.length) return;
            if (files.some(f => f.size > 20 * 1024 * 1024)) {
                dropzone.innerHTML = `
                    <div class="text-red-500">
                        <i class="fas fa-exclamation-circle text-4xl mb-2"></i>
                        <p class="font-medium">حجم یکی از فایل‌ها بیش از حد مجاز است (حداکثر ۲۰ مگابایت)</p>
                        <button onclick="resetDropzone()" class="mt-3 bg-blue-50 text-blue-600 px-4 py-2 rounded-lg text-sm">
                            تلاش مجدد
                        </button>
                    </div>
                `;
                return;
            }
            dropzone.innerHTML = `
                <div class="flex flex-col items-center">
                    <i class="fas fa-spinner fa-spin text-blue-500 text-4xl mb-3"></i>
                    <p class="font-medium">در حال پردازش فایل‌ها...</p>
                </div>
            `;
            progressContainer.classList.remove('hidden');
            resultContainer.style.display = 'none';

            let allResults = [];
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                let fileResult = '';
                if (file.type === 'application/pdf') {
                    // PDF: use pdf.js
                    const pdf = await pdfjsLib.getDocument(URL.createObjectURL(file)).promise;
                    for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                        const page = await pdf.getPage(pageNum);
                        const viewport = page.getViewport({ scale: 2 });
                        const canvas = document.createElement('canvas');
                        canvas.width = viewport.width;
                        canvas.height = viewport.height;
                        await page.render({ canvasContext: canvas.getContext('2d'), viewport }).promise;
                        const dataUrl = canvas.toDataURL();
                        const { data: { text } } = await Tesseract.recognize(
                            dataUrl,
                            'fas',
                            {
                                logger: progress => {
                                    if (progress.status === 'recognizing text') {
                                        const percent = Math.round(progress.progress * 100);
                                        document.getElementById('progress-bar').style.width = `${percent}%`;
                                        document.getElementById('progress-percent').textContent = `PDF صفحه ${pageNum}: ${percent}%`;
                                    }
                                }
                            }
                        );
                        fileResult += `\n--- صفحه ${pageNum} ---\n` + postProcessFarsi(text);
                    }
                } else {
                    // Image: preprocess then OCR
                    await new Promise(resolve => {
                        preprocessImage(file, async (dataUrl) => {
                            const { data: { text } } = await Tesseract.recognize(
                                dataUrl,
                                'fas',
                                {
                                    logger: progress => {
                                        if (progress.status === 'recognizing text') {
                                            const percent = Math.round(progress.progress * 100);
                                            document.getElementById('progress-bar').style.width = `${percent}%`;
                                            document.getElementById('progress-percent').textContent = `${file.name}: ${percent}%`;
                                        }
                                    }
                                }
                            );
                            fileResult = postProcessFarsi(text);
                            resolve();
                        });
                    });
                }
                allResults.push({
                    name: file.name,
                    text: fileResult.trim()
                });
            }

            // Show results per file
            let resultHtml = '';
            allResults.forEach((res, idx) => {
                resultHtml += `
                    <div class="mb-6">
                        <h4 class="font-bold mb-2 text-base">نتیجه فایل: ${res.name}</h4>
                        <textarea class="w-full h-40 p-3 border rounded-lg text-gray-800 rtl-text" readonly style="font-family: 'Noto Naskh Arabic', serif; direction: rtl;">${res.text}</textarea>
                        <div class="flex justify-end mt-2 space-x-2 space-x-reverse">
                            <button onclick="copyToClipboard(\`${res.text.replace(/`/g, '\\`')}\`)" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded-lg text-sm">
                                <i class="fas fa-copy ml-1"></i> کپی متن
                            </button>
                            <button onclick="downloadText(\`${res.text.replace(/`/g, '\\`')}\`, '${res.name.replace(/[^a-zA-Z0-9]/g, '_')}.txt')" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded-lg text-sm">
                                <i class="fas fa-download ml-1"></i> دانلود متن
                            </button>
                        </div>
                    </div>
                `;
            });
            resultContainer.innerHTML = `
                <h3 class="font-bold mb-3 text-lg">متن استخراج شده:</h3>
                ${resultHtml}
            `;
            resultContainer.style.display = 'block';
            progressContainer.classList.add('hidden');

            // Reset dropzone
            dropzone.innerHTML = `
                <div class="mb-4">
                    <i class="fas fa-check-circle text-green-500 text-4xl"></i>
                </div>
                <h3 class="text-lg font-medium text-gray-800 mb-2">پردازش با موفقیت انجام شد!</h3>
                <p class="text-gray-500 text-sm mb-4">برای پردازش فایل جدید، دوباره کلیک کنید</p>
                <button class="bg-blue-50 hover:bg-blue-100 text-blue-600 px-5 py-2 rounded-lg text-sm font-medium transition duration-300">
                    انتخاب فایل جدید
                </button>
            `;
        });
    });
    </script>
</body>
</html>
